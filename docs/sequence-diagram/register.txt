@startuml
mainframe **sd: Đăng ký tài khoản**
actor Actor as actor
boundary SignUpPage as signup
boundary VerifyPage as verify
boundary LoginPage as login
control AccessController as controller
control AccessService as service
entity User as user
entity UserDB as userdb
database Database as db

actor -> signup: 1. input(firstName,\nlastName, email, password)
activate actor
activate signup
signup -> controller: 2. sendRequest(firstName,\nlastName, email, password)
activate controller
controller -> service: 3. register(firstName,\nlastName, email, password)
activate service
service -> userdb: 4. findOneByEmail(email)
activate userdb
userdb -> db: 5. findOne(email)
deactivate userdb
activate db
db --> service: 6. return(user)
deactivate db
service-> service: 7. checkExist(user)
activate service
deactivate service


alt does not exist
service -> user: 8. newUser(firstName, lastName,\nemail, password)
activate user
user --> service: 9. return
deactivate user
service -> userdb: 10. createUser(user)
activate userdb
userdb -> db: 11. create(user)
deactivate userdb
activate db
db --> service : 12. return
deactivate db
service --> controller: 13. return(token)
controller --> signup: 14. return(token)
signup -> controller: 15. sendRequest(token)
controller -> service: 16. sendMailToken(request.token)
service -> service: 17. sendEmail(email)
activate service
deactivate service
service --> controller: 18. return
controller --> signup: 19. return
signup-> verify: 20. navigate(token)

activate verify
actor -> verify: 21. inputOTP(code)
verify -> controller: 22. sendRequest(OTPcode)
controller -> service: 23. verifyEmail(OTPcode)
service -> userdb: 24. updateVerifyEmail(email)
activate userdb
userdb -> db: 25. findOneAndUpdate(email)
deactivate userdb
activate db
db --> service: 26. return
deactivate db
service --> controller: 27. return
controller -> verify: 28. return
verify -> login: 29. navigate()
deactivate verify


else exist
service--> controller: 8.2. return
deactivate service
controller --> signup: 8.2.1. message("User already registered")

end


opt
actor -> signup: 1.2 clickSignIn()
ref over signup, controller
**sd: Đăng nhập**
end ref
end

hide footbox
@enduml